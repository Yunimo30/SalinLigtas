class AuthController {
    constructor() {
        this.authService = window.authService;
        this.isLoading = false;
        this.errorMessage = '';
        this.successMessage = '';
        this.initializeUI();
        this.bindEvents();
        this.checkAuthState();
    }

    initializeUI() {
        // Get all UI elements
        this.authControls = document.getElementById('authControls');
        this.loginModal = document.getElementById('loginModal');
        this.registerModal = document.getElementById('registerModal');
        this.resetPasswordModal = document.getElementById('resetPasswordModal');
        this.userProfileModal = document.getElementById('userProfileModal');

        // Get forms
        this.loginForm = document.getElementById('loginForm');
        this.registerForm = document.getElementById('registerForm');
        this.resetPasswordForm = document.getElementById('resetPasswordForm');

        // Get modal navigation buttons
        this.showRegisterBtn = document.getElementById('showRegisterBtn');
        this.showLoginBtn = document.getElementById('showLoginBtn');
        this.forgotPasswordBtn = document.getElementById('forgotPasswordBtn');

        // Profile related buttons
        this.editProfileBtn = document.getElementById('editProfileBtn');
        this.changePasswordBtn = document.getElementById('changePasswordBtn');
        this.logoutBtn = document.getElementById('logoutBtn');

        // Initialize modal close buttons
        const closeButtons = document.querySelectorAll('.modal .close');
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                this.closeAllModals();
            });
        });

        // Add link to auth.css if not already present
        if (!document.querySelector('link[href="styles/auth.css"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'styles/auth.css';
            document.head.appendChild(link);
        }
    }

    bindEvents() {
        // Login events
        this.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
        
        // Register events
        this.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
        
        // Reset password events
        this.resetPasswordForm.addEventListener('submit', (e) => this.handleResetPassword(e));
        
        // Modal navigation
        this.showRegisterBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.closeAllModals();
            this.showModal(this.registerModal);
        });
        
        this.showLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.closeAllModals();
            this.showModal(this.loginModal);
        });
        
        this.forgotPasswordBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.closeAllModals();
            this.showModal(this.resetPasswordModal);
        });

        // Profile actions
        if (this.logoutBtn) {
            this.logoutBtn.addEventListener('click', () => this.handleLogout());
        }

        if (this.editProfileBtn) {
            this.editProfileBtn.addEventListener('click', () => this.handleEditProfile());
        }

        if (this.changePasswordBtn) {
            this.changePasswordBtn.addEventListener('click', () => this.handleChangePassword());
        }

        // Password visibility toggles
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                const input = e.target.closest('.password-group').querySelector('input');
                const type = input.type === 'password' ? 'text' : 'password';
                input.type = type;
                toggle.innerHTML = `<i class="fas fa-eye${type === 'password' ? '' : '-slash'}"></i>`;
            });
        });
    }

    checkAuthState() {
        this.authService.onAuthStateChange((user) => {
            if (user) {
                this.updateUIForAuthenticatedUser(user);
            } else {
                this.updateUIForUnauthenticatedUser();
            }
        });
    }

    updateUIForAuthenticatedUser(user) {
        // Update auth controls in header
        this.authControls.innerHTML = `
            <button class="header-auth-btn" onclick="authController.showModal(userProfileModal)">
                <i class="fas fa-user-circle"></i> ${user.displayName || 'Profile'}
            </button>
        `;

        // Update profile information
        if (user.photoURL) {
            document.getElementById('userAvatar').src = user.photoURL;
        }
        document.getElementById('userName').textContent = user.displayName || 'Anonymous';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('memberSince').textContent = new Date(user.metadata.creationTime).toLocaleDateString();
        document.getElementById('lastLogin').textContent = new Date(user.metadata.lastSignInTime).toLocaleDateString();
        document.getElementById('userRole').textContent = user.role || 'User';
    }

    updateUIForUnauthenticatedUser() {
        this.authControls.innerHTML = `
            <button class="header-auth-btn" onclick="authController.showModal(loginModal)">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        `;
    }

    async handleLogin(e) {
        e.preventDefault();
        if (this.isLoading) return;

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            this.isLoading = true;
            this.showLoading(this.loginForm);
            await this.authService.login(email, password);
            this.closeAllModals();
            this.showSuccessMessage('Successfully logged in!');
        } catch (error) {
            this.showErrorMessage(this.getErrorMessage(error));
        } finally {
            this.isLoading = false;
            this.hideLoading(this.loginForm);
        }
    }

    async handleRegister(e) {
        e.preventDefault();
        if (this.isLoading) return;

        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;
        const role = document.getElementById('userRole').value;

        if (password !== confirmPassword) {
            this.showErrorMessage('Passwords do not match');
            return;
        }

        try {
            this.isLoading = true;
            this.showLoading(this.registerForm);
            const userData = {
                displayName: name,
                role: role
            };
            await this.authService.register(email, password, userData);
            this.closeAllModals();
            this.showSuccessMessage('Registration successful! Please log in.');
            this.showModal(this.loginModal);
        } catch (error) {
            this.showErrorMessage(this.getErrorMessage(error));
        } finally {
            this.isLoading = false;
            this.hideLoading(this.registerForm);
        }
    }

    async handleResetPassword(e) {
        e.preventDefault();
        if (this.isLoading) return;

        const email = document.getElementById('resetEmail').value;

        try {
            this.isLoading = true;
            this.showLoading(this.resetPasswordForm);
            await this.authService.resetPassword(email);
            this.closeAllModals();
            this.showSuccessMessage('Password reset email sent. Please check your inbox.');
        } catch (error) {
            this.showErrorMessage(this.getErrorMessage(error));
        } finally {
            this.isLoading = false;
            this.hideLoading(this.resetPasswordForm);
        }
    }

    async handleLogout() {
        try {
            await this.authService.logout();
            this.closeAllModals();
            this.showSuccessMessage('Successfully logged out!');
        } catch (error) {
            this.showErrorMessage(this.getErrorMessage(error));
        }
    }

    handleEditProfile() {
        // TODO: Implement edit profile functionality
        console.log('Edit profile clicked');
    }

    handleChangePassword() {
        // TODO: Implement change password functionality
        console.log('Change password clicked');
    }

    showModal(modal) {
        this.closeAllModals();
        modal.style.display = 'block';
    }

    closeAllModals() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.style.display = 'none';
        });
    }

    showLoading(form) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="auth-loading"></span> Loading...';
        }
    }

    hideLoading(form) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = submitBtn.textContent;
        }
    }

    showErrorMessage(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'auth-error';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            ${message}
        `;

        // Remove any existing alerts
        document.querySelectorAll('.auth-error, .auth-success').forEach(el => el.remove());

        // Add new alert at the top of the active modal
        const activeModal = document.querySelector('.modal[style*="block"]');
        if (activeModal) {
            const modalContent = activeModal.querySelector('.modal-content');
            modalContent.insertBefore(alertDiv, modalContent.firstChild.nextSibling);
        }

        // Auto remove after 5 seconds
        setTimeout(() => alertDiv.remove(), 5000);
    }

    showSuccessMessage(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'auth-success';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle"></i>
            ${message}
        `;

        // Remove any existing alerts
        document.querySelectorAll('.auth-error, .auth-success').forEach(el => el.remove());

        // Show alert in a non-modal context since modals might be closed
        document.body.appendChild(alertDiv);
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';

        // Auto remove after 5 seconds
        setTimeout(() => alertDiv.remove(), 5000);
    }

    getErrorMessage(error) {
        switch (error.code) {
            case 'auth/user-not-found':
                return 'No user found with this email address.';
            case 'auth/wrong-password':
                return 'Incorrect password.';
            case 'auth/email-already-in-use':
                return 'Email address is already registered.';
            case 'auth/weak-password':
                return 'Password should be at least 6 characters.';
            case 'auth/invalid-email':
                return 'Invalid email address.';
            default:
                return error.message;
        }
    }
}

// Initialize the authentication controller when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.authController = new AuthController();
});